(this.webpackJsonpp2wiki=this.webpackJsonpp2wiki||[]).push([[0],{103:function(e,t,n){},104:function(e,t,n){},132:function(e,t){},134:function(e,t){},141:function(e,t){},142:function(e,t){},156:function(e,t){},157:function(e,t){},159:function(e,t){},161:function(e,t){},163:function(e,t){},178:function(e,t){},183:function(e,t){},185:function(e,t){},186:function(e,t){},189:function(e,t){},190:function(e,t){},193:function(e,t){},196:function(e,t){},224:function(e,t){},225:function(e,t,n){},226:function(e,t,n){"use strict";n.r(t);var a=n(1),i=n.n(a),r=n(95),o=n.n(r),c=(n(103),n(104),n(22)),s=n(23),l=n(34),u=n(33),h=n(96),m=n(13),d=n(47),p=n(35),f=n.n(p),y=n(97),g=n.n(y),v=n(145),x=n(8)("p2wiki"),w=function(){function e(t){Object(c.a)(this,e),this.proxyPeers={},this.proxyPeersID=[],this.curProxyPeerIndex=0,this.announceURLs=t,this.wt=new v,this.p2pt=new g.a(t,"p2wiki")}return Object(s.a)(e,[{key:"startProxy",value:function(){var e=this;this.p2pt.on("msg",(function(t,n){if("c"===n)t.respond("p").catch((function(e){console.error("Connection to client failed before handsahake. "+e)}));else try{n=JSON.parse(n),console.log("Got request for article "+n.articleName),e.makeArticleTorrent(n.articleName).then((function(e){t.respond(e.infoHash)}))}catch(a){console.log(a)}})),this.p2pt.start()}},{key:"startClient",value:function(){var e=this,t=this;this.p2pt.on("peerconnect",(function(e){t.p2pt.send(e,"c").then((function(e){var n=Object(d.a)(e,2),a=n[0];"p"===n[1]&&(t.proxyPeers[a.id]=a,t.proxyPeersID.push(a.id))}))})),this.p2pt.on("peerclose",(function(n){delete t.proxyPeers[n],delete t.proxyPeersID[e.proxyPeersID.indexOf(n)]})),this.p2pt.start()}},{key:"getAProxyPeer",value:function(){return 0!==this.proxyPeersID.length&&(this.curProxyPeerIndex>this.proxyPeersID.length-1&&(this.curProxyPeerIndex=0),this.proxyPeers[this.proxyPeersID[this.curProxyPeerIndex]])}},{key:"makeArticleTorrent",value:function(e){var t=this;return new Promise((function(n,a){var i=[],r={title:"",article:!1,media:[],mediaCount:0};e=encodeURIComponent(e);var o=function(){r.article&&r.media.length===r.mediaCount&&t.wt.seed(i,{announceList:[t.announceURLs],name:r.title},(function(e){n(e)}))};f.a.get("//en.wikipedia.org/w/api.php?action=parse&format=json&page=".concat(e,"&prop=text&formatversion=2&origin=*")).then((function(t){var n=new window.File([t.data.parse.text],"article.html",{type:"text/html"});i.push(n),r.title=t.data.parse.title,r.article=!0,x("Article ".concat(e," : Fetched text")),o()})).catch((function(e){a(e)}));var c=function(t,n,c){f()({method:"get",url:c,responseType:"blob"}).then((function(n){var a=t,c=new window.File([n.data],a);i.push(c),r.media.push(a),x("Article ".concat(e," : Fetched image ").concat(r.media.length,"/").concat(r.mediaCount)),o()})).catch((function(e){a(e)}))};f.a.get("//en.wikipedia.org/api/rest_v1/page/media-list/".concat(e)).then((function(t){var n;for(var a in t.data.items)(n=t.data.items[a]).srcset&&(c(n.title,n.srcset[0].scale,n.srcset[0].src),r.mediaCount++);x("Article ".concat(e," : Fetched medialist. Has ").concat(r.mediaCount," images"))})).catch((function(e){a(e)}))}))}},{key:"requestArticle",value:function(e,t,n){this.p2pt.requestMorePeers();var a=this.getAProxyPeer();if(!a)return!1;var i=this;this.p2pt.send(a,JSON.stringify({articleName:e})).then((function(e){var n=Object(d.a)(e,2),a=(n[0],n[1]);i.wt.add(a,{announce:i.announceURLs},(function(e){var n={title:"",text:null,media:{}};e.files.forEach((function(t){"article.html"===t.name?(n.title=e.name,n.text=t):n.media[t.name]=t})),t(n)}))}))}}]),e}(),b=function(e){Object(l.a)(n,e);var t=Object(u.a)(n);function n(e){var a;Object(c.a)(this,n),(a=t.call(this,e)).handleChange=a.handleChange.bind(Object(m.a)(a)),a.handleSubmit=a.handleSubmit.bind(Object(m.a)(a)),a.getFromWiki=a.getFromWiki.bind(Object(m.a)(a)),a.state={title:"",query:"",result:"",beAProxy:!1},a.media={},a.retryInterval=null;var i=["wss://tracker.openwebtorrent.com","wss://tracker.sloppyta.co:443/announce","wss://tracker.novage.com.ua:443/announce","wss://tracker.btorrent.xyz:443/announce"];"localhost"===window.location.hostname&&(i=["ws://localhost:5000"]),a.p2wiki=new w(i),"true"===window.localStorage.getItem("beAProxy")?(a.state.beAProxy=!0,a.p2wiki.startProxy()):a.p2wiki.startClient();var r=Object(m.a)(a),o=document.location.pathname.split("/");return o.length>2&&"wiki"===o[o.length-2]&&setTimeout((function(){r.urloli(o[o.length-1]),r.getFromWiki()}),1e3),a}return Object(s.a)(n,[{key:"getFromWiki",value:function(){if(""!==this.state.query){var e=this;!1===this.p2wiki.requestArticle(this.state.query,(function(t){e.media=t.media,t.text.getBuffer((function(n,a){e.setState({title:t.title,result:a.toString()}),n&&console.log(n)}))}))&&(console.log("nopeer, retrying in 3 seconds"),clearInterval(this.retryInterval),this.retryInterval=setTimeout(this.getFromWiki,3e3))}}},{key:"handleSubmit",value:function(e){e.preventDefault(),console.log(this.state.query),this.getFromWiki()}},{key:"handleChange",value:function(e){var t="checkbox"===e.target.type?e.target.checked:e.target.value;this.setState(Object(h.a)({},e.target.name,t)),"beAProxy"===e.target.name&&(window.localStorage.setItem("beAProxy",t),window.location.reload())}},{key:"urloli",value:function(e){this.setState({query:e})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this.handleSubmit},i.a.createElement("label",{style:{paddingBottom:"15px"},className:"checkbox"},i.a.createElement("input",{type:"checkbox",onChange:this.handleChange,name:"beAProxy",checked:this.state.beAProxy}),i.a.createElement("span",{style:{marginLeft:"5px"}},"Be a Proxy Peer")),i.a.createElement("div",{className:"field"},i.a.createElement("div",{style:{textAlign:"center"},className:"control"},i.a.createElement("input",{className:"input is-rounded",id:"query",type:"Text",placeholder:"\ud83d\udd0d Search for an article",onChange:this.handleChange,name:"query",value:this.state.query})))),i.a.createElement("div",{className:"container mx-auto"},i.a.createElement("h1",{className:"title text-4xl"},this.state.title),i.a.createElement("div",{dangerouslySetInnerHTML:function(t){for(var n,a=(t=(new window.DOMParser).parseFromString(t,"text/html")).querySelectorAll("a[class='image']"),i=0;i<a.length;i++)n=new URL(a[i].href).pathname.slice(6),a[i].firstChild.src="",e.media[n]&&e.media[n].renderTo(a[i].firstChild);return{__html:t.body.innerHTML}}(this.state.result)})))}}]),n}(a.Component),k=(n(225),function(e){Object(l.a)(n,e);var t=Object(u.a)(n);function n(){return Object(c.a)(this,n),t.apply(this,arguments)}return Object(s.a)(n,[{key:"render",value:function(){return i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{style:{textAlign:"center"}},i.a.createElement("h1",{style:{color:"royalblue",fontSize:"50px"}},"P2Wiki"),i.a.createElement(b,null)),i.a.createElement("footer",{className:"footer"},i.a.createElement("div",{style:{textAlign:"center"}},i.a.createElement("p",{style:{color:"hotpink"}},"P2Wiki made by Subin Siby, Pranav Shridhar and Athul Cyriac Ajay"))))}}]),n}(a.Component));var P=function(){return i.a.createElement("div",{className:"App"},i.a.createElement(k,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(i.a.createElement(P,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))},98:function(e,t,n){e.exports=n(226)}},[[98,1,2]]]);
//# sourceMappingURL=main.c3e5c526.chunk.js.map