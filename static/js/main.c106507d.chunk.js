(this.webpackJsonpp2wiki=this.webpackJsonpp2wiki||[]).push([[0],{102:function(e,t,n){},103:function(e,t,n){},132:function(e,t){},134:function(e,t){},150:function(e,t){},151:function(e,t){},153:function(e,t){},155:function(e,t){},157:function(e,t){},173:function(e,t){},178:function(e,t){},180:function(e,t){},181:function(e,t){},182:function(e,t){},184:function(e,t){},188:function(e,t){},189:function(e,t){},192:function(e,t){},195:function(e,t){},223:function(e,t){},224:function(e,t,n){"use strict";n.r(t),function(e,t){var r=n(13),i=n(14),a=n(26),o=n(25),s=n(85),c=n(24),l=n(11),u=n(22),h=n(8)("p2pt"),d=function(t){Object(a.a)(l,t);var n=Object(o.a)(l);function l(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return Object(r.a)(this,l),(e=n.call(this)).announceURLs=t,e.trackers={},e.peers={},e.msgChunks={},e.responseWaiting={},i&&e.setIdentifier(i),e._peerIdBuffer=c(20),e._peerId=e._peerIdBuffer.toString("hex"),e._peerIdBinary=e._peerIdBuffer.toString("binary"),e}return Object(i.a)(l,[{key:"setIdentifier",value:function(t){this.identifierString=t,this.infoHash=u.sync(t).toLowerCase(),this._infoHashBuffer=e.from(this.infoHash,"hex"),this._infoHashBinary=this._infoHashBuffer.toString("binary")}},{key:"start",value:function(){var e=this;this.on("peer",(function(t){var n=!1;e.peers[t.id]||(n=!0,e.peers[t.id]={},e.responseWaiting[t.id]={}),t.on("connect",(function(){e.peers[t.id][t.channelName]=t,n&&e.emit("peerconnect",t)})),t.on("data",(function(n){if(e.emit("data",t,n),n=n.toString(),h("got a message from "+t.id),"p"===n[0])try{n=JSON.parse(n.slice(1)),t.respond=e._peerRespond(t,n.id);var r=e._chunkHandler(n);!1!==r&&(e.responseWaiting[t.id][n.id]?(e.responseWaiting[t.id][n.id]([t,r]),delete e.responseWaiting[t.id][n.id]):e.emit("msg",t,r),e._destroyChunks(n.id))}catch(i){console.log(i)}})),t.on("error",(function(n){e.removePeer(t),h("Error in connection : "+n)})),t.on("close",(function(){e.removePeer(t),h("Connection closed with "+t.id)}))})),this._fetchPeers()}},{key:"removePeer",value:function(e){delete this.peers[e.id][e.channelName],0===this.peers[e.id].length&&(this.emit("peerclose",e),delete this.responseWaiting[e.id],delete this.peers[e.id])}},{key:"send",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",r=this;return new Promise((function(i,a){var o={id:""!==n?n:Math.floor(1e5*Math.random()+1e5),msg:t};try{e.connected||(e=r.peers[e.id][0]),r.responseWaiting[e.id][o.id]=i}catch(l){return a(Error("Connection to peer closed"))}for(var s=0,c="";o.msg.length>0;)o.c=s,c=o.msg.slice(16e3),o.msg=o.msg.slice(0,16e3),c||(o.last=!0),e.send("p"+JSON.stringify(o)),o.msg=c,s++;h("sent a message to "+e.id)}))}},{key:"requestMorePeers",value:function(){var e=this;return new Promise((function(t){for(var n in e.trackers)e.trackers[n].announce({numwant:50});t(e.peers)}))}},{key:"destroy",value:function(){var e;for(e in this.peers)for(var t in this.peers[e])this.peers[e][t].destroy();for(e in this.trackers)this.trackers[e].destroy()}},{key:"_peerRespond",value:function(e,t){var n=this;return function(r){return n.send(e,r,t)}}},{key:"_chunkHandler",value:function(e){return this.msgChunks[e.id]||(this.msgChunks[e.id]=[]),this.msgChunks[e.id][e.c]=e.msg,!!e.last&&this.msgChunks[e.id].join("")}},{key:"_destroyChunks",value:function(e){delete this.msgChunks[e]}},{key:"_defaultAnnounceOpts",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return null==e.numwant&&(e.numwant=50),null==e.uploaded&&(e.uploaded=0),null==e.downloaded&&(e.downloaded=0),e}},{key:"_fetchPeers",value:function(){for(var e in this.announceURLs)this.trackers[e]=new s(this,this.announceURLs[e]),this.trackers[e].announce({numwant:50})}}]),l}(l);t.exports=d}.call(this,n(0).Buffer,n(225)(e))},226:function(e,t,n){},227:function(e,t,n){"use strict";n.r(t);var r=n(1),i=n.n(r),a=n(95),o=n.n(a),s=(n(102),n(103),n(13)),c=n(14),l=n(26),u=n(25),h=n(96),d=n(15),f=n(47),p=n(35),m=n.n(p),g=n(120),y=n(21),v=n(224),k=n(8)("p2wiki"),w=function(){function e(t){Object(s.a)(this,e),this.announceURLs=t,this.proxyPeers={},this.proxyPeersID=[],this.curProxyPeerIndex=0,this.seedingTorrents={},this.wt=new g,this.p2pt=new v(t,"p2wiki")}return Object(c.a)(e,[{key:"startProxy",value:function(){var e=this;this.p2pt.on("msg",(function(t,n){if("c"===n)t.respond("p").catch((function(e){console.error("Connection to client failed before handsahake. "+e)}));else try{n=JSON.parse(n);var r=encodeURIComponent(n.articleName);console.log("Got request for article "+r),e.makeArticleTorrent(n.articleName).then((function(e){t.respond(e.infoHash)})).catch((function(t){console.log("Torrent creation failed : "+t),delete e.seedingTorrents[r]}))}catch(i){console.log(i)}})),this.p2pt.start(),y([function(){setInterval((function(){var t,n=new Date;for(var r in e.seedingTorrents)(t=e.seedingTorrents[r]).lastActive&&n-t.lastActive>12e4&&t.torrent.destroy()}),1e4)}])}},{key:"startClient",value:function(){var e=this,t=this;this.p2pt.on("peerconnect",(function(e){t.p2pt.send(e,"c").then((function(e){var n=Object(f.a)(e,2),r=n[0],i=n[1];console.log(r.id),"p"===i&&(t.proxyPeers[r.id]?r.destroy():(t.proxyPeers[r.id]=r,t.proxyPeersID.push(r.id)))}))})),this.p2pt.on("peerclose",(function(n){delete t.proxyPeers[n],delete t.proxyPeersID[e.proxyPeersID.indexOf(n)]})),this.p2pt.start()}},{key:"getAProxyPeer",value:function(){return 0!==this.proxyPeersID.length&&(this.curProxyPeerIndex>this.proxyPeersID.length-1&&(this.curProxyPeerIndex=0),this.proxyPeers[this.proxyPeersID[this.curProxyPeerIndex]])}},{key:"makeArticleTorrent",value:function(e){var t=this;return new Promise((function(n,r){if(e=encodeURIComponent(e),t.seedingTorrents[e])t.seedingTorrents[e].torrent&&n(t.seedingTorrents[e].torrent);else{t.seedingTorrents[e]={};var i=[],a={title:"",article:!1,media:[],mediaCount:0},o=function(){a.article&&a.media.length===a.mediaCount&&t.wt.seed(i,{announceList:[t.announceURLs],name:a.title},(function(r){t.seedingTorrents[e]={lastActive:new Date,torrent:r},r.on("upload",(function(){t.seedingTorrents[e].lastActive=new Date})),k("Started seeding article '".concat(e,"' : ").concat(r.infoHash)),n(r)}))};m.a.get("//en.wikipedia.org/w/api.php?action=parse&format=json&page=".concat(e,"&prop=text&formatversion=2&origin=*")).then((function(t){var n=new window.File([t.data.parse.text],"article.html",{type:"text/html"});i.push(n),a.title=t.data.parse.title,a.article=!0,k("Article ".concat(e," : Fetched text")),o()})).catch((function(e){r(e)}));var s=function(t,n,s){m()({method:"get",url:s,responseType:"blob"}).then((function(n){var r=t,s=new window.File([n.data],r);i.push(s),a.media.push(r),k("Article ".concat(e," : Fetched image ").concat(a.media.length,"/").concat(a.mediaCount)),o()})).catch((function(e){r(e)}))};m.a.get("//en.wikipedia.org/api/rest_v1/page/media-list/".concat(e)).then((function(t){var n;for(var r in t.data.items)(n=t.data.items[r]).srcset&&(s(n.title,n.srcset[0].scale,n.srcset[0].src),a.mediaCount++);k("Article ".concat(e," : Fetched medialist. Has ").concat(a.mediaCount," images"))})).catch((function(e){r(e)}))}}))}},{key:"requestArticle",value:function(e,t,n){if(this.p2pt.requestMorePeers(),0===this.proxyPeers.length)return!1;var r,i=this,a=[];for(var o in this.proxyPeers)r=this.proxyPeers[o],this.p2pt.send(r,JSON.stringify({articleName:e})).then((function(e){var n=Object(f.a)(e,2),r=(n[0],n[1]);a.push(r);var o=i.checkConsensus(a);o&&i.downloadTorrent(o,t)}))}},{key:"checkConsensus",value:function(e){var t,n={};for(var r in e)if(n[t=e[r]]||(n[t]=0),n[t]++,n[t]>=1)return t;return!1}},{key:"downloadTorrent",value:function(e,t){var n=function(e){var n={title:"",text:null,media:{}};e.files.forEach((function(t){"article.html"===t.name?(n.title=e.name,n.text=t):n.media[t.name]=t})),t(n)};this.wt.get(e)?n(this.wt.get(e)):this.wt.add(e,{announce:this.announceURLs},n)}}]),e}(),x=function(e){Object(l.a)(n,e);var t=Object(u.a)(n);function n(e){var r;Object(s.a)(this,n),(r=t.call(this,e)).handleChange=r.handleChange.bind(Object(d.a)(r)),r.handleSubmit=r.handleSubmit.bind(Object(d.a)(r)),r.getFromWiki=r.getFromWiki.bind(Object(d.a)(r)),r.state={title:"",query:"",result:"",beAProxy:!1},r.media={},r.retryInterval=null;var i=["wss://tracker.openwebtorrent.com","wss://tracker.sloppyta.co:443/announce","wss://tracker.novage.com.ua:443/announce","wss://tracker.btorrent.xyz:443/announce"];"localhost"===window.location.hostname&&(i=["ws://localhost:5000"]),r.p2wiki=new w(i),"true"===window.localStorage.getItem("beAProxy")?(r.state.beAProxy=!0,r.p2wiki.startProxy()):r.p2wiki.startClient();var a=Object(d.a)(r),o=document.location.pathname.split("/");return o.length>2&&"wiki"===o[o.length-2]&&setTimeout((function(){a.urloli(o[o.length-1]),a.getFromWiki()}),1e3),r}return Object(c.a)(n,[{key:"getFromWiki",value:function(){if(""!==this.state.query){var e=this;!1===this.p2wiki.requestArticle(this.state.query,(function(t){e.media=t.media,t.text.getBuffer((function(n,r){e.setState({title:t.title,result:r.toString()}),n&&console.log(n)}))}))&&(console.log("nopeer, retrying in 3 seconds"),clearInterval(this.retryInterval),this.retryInterval=setTimeout(this.getFromWiki,3e3))}}},{key:"handleSubmit",value:function(e){e.preventDefault(),console.log(this.state.query),this.getFromWiki()}},{key:"handleChange",value:function(e){var t="checkbox"===e.target.type?e.target.checked:e.target.value;this.setState(Object(h.a)({},e.target.name,t)),"beAProxy"===e.target.name&&(window.localStorage.setItem("beAProxy",t),window.location.reload())}},{key:"urloli",value:function(e){this.setState({query:e})}},{key:"render",value:function(){var e=this;return i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this.handleSubmit},i.a.createElement("label",{style:{paddingBottom:"15px"},className:"checkbox"},i.a.createElement("input",{type:"checkbox",onChange:this.handleChange,name:"beAProxy",checked:this.state.beAProxy}),i.a.createElement("span",{style:{marginLeft:"5px"}},"Be a Proxy Peer")),i.a.createElement("div",{className:"field"},i.a.createElement("div",{style:{textAlign:"center"},className:"control"},i.a.createElement("input",{className:"input is-rounded",id:"query",type:"Text",placeholder:"\ud83d\udd0d Search for an article",onChange:this.handleChange,name:"query",value:this.state.query})))),i.a.createElement("div",{className:"container mx-auto"},i.a.createElement("h1",{className:"title text-4xl"},this.state.title),i.a.createElement("div",{dangerouslySetInnerHTML:function(t){for(var n,r=(t=(new window.DOMParser).parseFromString(t,"text/html")).querySelectorAll("a[class='image']"),i=0;i<r.length;i++)n=new URL(r[i].href).pathname.slice(6),r[i].firstChild.src="",e.media[n]&&e.media[n].renderTo(r[i].firstChild);return{__html:t.body.innerHTML}}(this.state.result)})))}}]),n}(r.Component),b=(n(226),function(e){Object(l.a)(n,e);var t=Object(u.a)(n);function n(){return Object(s.a)(this,n),t.apply(this,arguments)}return Object(c.a)(n,[{key:"render",value:function(){return i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{style:{textAlign:"center"}},i.a.createElement("h1",{style:{color:"royalblue",fontSize:"50px"}},"P2Wiki"),i.a.createElement(x,null)),i.a.createElement("footer",{className:"footer"},i.a.createElement("div",{style:{textAlign:"center"}},i.a.createElement("p",{style:{color:"hotpink"}},"P2Wiki made by Subin Siby, Pranav Shridhar and Athul Cyriac Ajay"))))}}]),n}(r.Component));var P=function(){return i.a.createElement("div",{className:"App"},i.a.createElement(b,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));o.a.render(i.a.createElement(P,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()}))},97:function(e,t,n){e.exports=n(227)}},[[97,1,2]]]);
//# sourceMappingURL=main.c106507d.chunk.js.map